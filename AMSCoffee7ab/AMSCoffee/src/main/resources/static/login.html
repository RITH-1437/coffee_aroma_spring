<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Café Aroma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <!-- Background Pattern -->
    <div class="absolute inset-0 bg-coffee-brown opacity-5"
        style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23000000&quot; fill-opacity=&quot;0.1&quot;%3E%3Ccircle cx=&quot;30&quot; cy=&quot;30&quot; r=&quot;4&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');">
    </div>

    <div class="relative max-w-md w-full mx-4">
        <!-- Logo Header -->
        <div class="text-center mb-8">
            <a href="index.html" class="inline-flex items-center">
                <i class="fas fa-coffee text-coffee-brown text-3xl mr-3"></i>
                <span class="text-3xl font-bold text-coffee-brown brand-name">Café Aroma</span>
            </a>
            <p class="mt-2 text-gray-600">Welcome back! Please sign in to your account.</p>
        </div>

        <!-- Login Form -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Sign In</h2>

            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-envelope text-gray-400"></i>
                        </div>
                        <input type="email" id="email" name="email" required class="w-full pl-10 form-input"
                            placeholder="Enter your email">
                    </div>
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="password" name="password" required
                            class="w-full pl-10 pr-10 form-input" placeholder="Enter your password">
                        <button type="button" onclick="togglePassword('password')"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <i class="fas fa-eye text-gray-400 hover:text-gray-600" id="password-toggle"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Login As</label>
                    <select id="role" name="role" required class="w-full form-input">
                        <option value="customer">Customer</option>
                        <option value="administrator">Administrator</option>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember" name="remember"
                            class="h-4 w-4 text-coffee-brown focus:ring-coffee-brown border-gray-300 rounded">
                        <label for="remember" class="ml-2 text-sm text-gray-700">
                            Remember me
                        </label>
                    </div>
                    <a href="#" class="text-sm text-coffee-brown hover:text-coffee-dark" onclick="showForgotPassword()">
                        Forgot password?
                    </a>
                </div>

                <button type="submit" class="w-full btn-coffee">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Sign In
                </button>
            </form>

            <!-- Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Or continue with</span>
                </div>
            </div>

            <!-- Social Login -->
            <div class="grid grid-cols-2 gap-3">
                <button
                    class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <i class="fab fa-google text-red-500"></i>
                    <span class="ml-2">Google</span>
                </button>
                <button
                    class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <i class="fab fa-facebook text-blue-600"></i>
                    <span class="ml-2">Facebook</span>
                </button>
            </div>

            <!-- Sign Up Link -->
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">
                    Don't have an account?
                    <a href="register.html" class="font-medium text-coffee-brown hover:text-coffee-dark">
                        Sign up now
                    </a>
                </p>
            </div>

            <!-- Admin Login Link -->
            <!-- <div class="mt-4 text-center">
                <a href="admin/dashboard.html" class="text-xs text-gray-500 hover:text-coffee-brown">
                    Admin Login
                </a>
            </div> -->

            <!-- Test Credentials Buttons -->
            <div class="mt-4 text-center space-y-2">
                <p class="text-xs text-gray-500">Quick Test:</p>
                <div class="flex justify-center space-x-2">
                    <button type="button" onclick="fillTestUser()" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">
                        Fill Customer
                    </button>
                    <button type="button" onclick="fillTestAdmin()" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">
                        Fill Admin
                    </button>
                    <button type="button" onclick="debugLogin()" class="text-xs bg-blue-100 px-2 py-1 rounded hover:bg-blue-200">
                        Debug
                    </button>
                </div>
            </div>

        </div>

        <!-- Back to Home -->
        <div class="text-center mt-6">
            <a href="index.html" class="text-coffee-brown hover:text-coffee-dark">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Home
            </a>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Reset Password</h3>
                <button onclick="closeForgotPassword()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <p class="text-gray-600 mb-4">
                Enter your email address and we'll send you a link to reset your password.
            </p>

            <form id="forgot-password-form">
                <div class="mb-4">
                    <input type="email" id="forgot-email" placeholder="Enter your email" class="w-full form-input"
                        required>
                </div>

                <div class="flex space-x-3">
                    <button type="button" onclick="closeForgotPassword()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 btn-coffee">
                        Send Reset Link
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="assets/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is already logged in
            if (auth.isLoggedIn()) {
                const redirect = new URLSearchParams(window.location.search).get('redirect');
                window.location.href = redirect || 'index.html';
            }
        });

        // Login form submission
        document.getElementById('login-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const loginData = {
                email: formData.get('email')?.trim() || '',
                password: formData.get('password') || '',
                role: formData.get('role')?.trim() || '',
                remember: formData.get('remember') === 'on'
            };

            console.log('Login attempt:', loginData);
            console.log('Raw form data:', {
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            });

            // Validate form
            const errors = validateForm(loginData, {
                email: { required: true, email: true },
                password: { required: true, minLength: 6 },
                role: { required: true }
            });

            if (errors) {
                console.log('Validation errors:', errors);
                const firstError = Object.keys(errors)[0];
                showToast(errors[firstError], 'error');
                return;
            }

            try {
                showLoading();

                // Check if backend API is configured
                const API_BASE_URL = 'http://localhost:8080';

                if (API_BASE_URL) {
                    // Call backend API for login
                    const response = await fetch(`${API_BASE_URL}/api/users/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: loginData.email,
                            passwordHash: loginData.password
                        })
                    });

                    hideLoading();

                    if (response.ok) {
                        const result = await response.text();

                        if (result.startsWith('Bearer ')) {
                            // Extract token
                            const token = result.substring(7);

                            // Store token in localStorage
                            localStorage.setItem('authToken', token);

                            // Get user info (we can decode JWT or fetch user details)
                            // For now, create user object from login data
                            const user = {
                                email: loginData.email,
                                name: loginData.email.split('@')[0],
                                role: loginData.role
                            };

                            auth.login(user);
                            showToast('Login successful!', 'success');

                            // Redirect based on role
                            if (loginData.role === 'administrator') {
                                window.location.href = 'admin/dashboard.html';
                            } else {
                                window.location.href = 'index.html';
                            }
                        } else {
                            showToast('Invalid credentials', 'error');
                        }
                    } else {
                        const error = await response.text();
                        showToast(error || 'Login failed', 'error');
                    }
                } else {
                    // Fallback to demo users if no backend configured
                    hideLoading();

                    const demoUsers = [
                        { email: 'user@example.com', password: 'password', name: 'John Doe', role: 'customer' },
                        { email: 'admin@cafearoma.com', password: 'admin123', name: 'Admin User', role: 'administrator' }
                    ];

                    const roleMapping = {
                        'customer': 'customer',
                        'administrator': 'administrator'
                    };

                    const internalRole = roleMapping[loginData.role];
                    const user = demoUsers.find(u =>
                        u.email === loginData.email &&
                        u.password === loginData.password &&
                        u.role === internalRole
                    );

                    if (user) {
                        auth.login({
                            id: Math.floor(Math.random() * 1000),
                            email: user.email,
                            name: user.name,
                            role: user.role
                        });

                        showToast('Login successful!', 'success');

                        if (user.role === 'administrator') {
                            window.location.href = 'admin/dashboard.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    } else {
                        showToast('Invalid credentials or incorrect role selection', 'error');
                    }
                }

            } catch (error) {
                hideLoading();
                console.error('Login error details:', error);
                console.error('Error stack:', error.stack);
                showToast(`Login failed: ${error.message}`, 'error');
            }
        });

        // Forgot password form
        document.getElementById('forgot-password-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const email = document.getElementById('forgot-email').value;

            if (!email) {
                showToast('Please enter your email address', 'error');
                return;
            }

            if (!/\S+@\S+\.\S+/.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            // Fast reset email simulation
            hideLoading();
            closeForgotPassword();
            showToast('Password reset link sent to your email!', 'success');
            document.getElementById('forgot-email').value = '';
        });

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-toggle');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Forgot password modal functions
        function showForgotPassword() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeForgotPassword() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        document.getElementById('forgot-password-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeForgotPassword();
            }
        });

        // Demo login info
        console.log('Demo login credentials:');
        console.log('Customer: user@example.com / password (select Customer)');
        console.log('Admin: admin@cafearoma.com / admin123 (select Administrator)');

        // Test function for debugging
        window.testLogin = function () {
            console.log('Testing login functionality...');
            console.log('validateForm function:', typeof validateForm);
            console.log('showToast function:', typeof showToast);
            console.log('auth object:', auth);
        };

        // Quick fill functions for testing
        window.fillTestUser = function () {
            document.getElementById('email').value = 'user@example.com';
            document.getElementById('password').value = 'password';
            document.getElementById('role').value = 'customer';
        };

        window.fillTestAdmin = function () {
            document.getElementById('email').value = 'admin@cafearoma.com';
            document.getElementById('password').value = 'admin123';
            document.getElementById('role').value = 'administrator';
        };

        // Debug function to test credentials
        window.debugLogin = function () {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            console.log('=== DEBUG LOGIN ===');
            console.log('Form values:');
            console.log('  Email:', JSON.stringify(email));
            console.log('  Password:', JSON.stringify(password));
            console.log('  Role:', JSON.stringify(role));

            const demoUsers = [
                { email: 'user@example.com', password: 'password', name: 'John Doe', role: 'customer' },
                { email: 'admin@cafearoma.com', password: 'admin123', name: 'Admin User', role: 'administrator' }
            ];

            console.log('Demo users:');
            demoUsers.forEach((user, index) => {
                console.log(`  User ${index + 1}:`, JSON.stringify(user));
            });

            // Test each user
            demoUsers.forEach((user, index) => {
                const emailMatch = user.email === email;
                const passwordMatch = user.password === password;
                const roleMatch = user.role === role;
                const allMatch = emailMatch && passwordMatch && roleMatch;

                console.log(`User ${index + 1} matches:`);
                console.log(`  Email: ${emailMatch}`);
                console.log(`  Password: ${passwordMatch}`);
                console.log(`  Role: ${roleMatch}`);
                console.log(`  ALL: ${allMatch}`);
            });
        };
    </script>
</body>

</html>